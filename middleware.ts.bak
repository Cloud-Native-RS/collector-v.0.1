import { NextResponse, type NextRequest } from "next/server";
import { isAuthenticated, getAuthenticatedUser } from "@/lib/auth/middleware";

export function middleware(request: NextRequest) {
  // Temporarily simplified to debug the issue
  return NextResponse.next();
  
  /* TEMPORARILY DISABLED - DEBUGGING
  try {
    const { pathname } = request.nextUrl;

  // Public routes that don't require authentication
  const publicRoutes = [
    "/(auth)/login",
    "/(auth)/signup",
    "/(auth)/forgot-password",
    "/api/auth",
  ];

  const isPublicRoute = publicRoutes.some((route) => pathname.startsWith(route));
  const isCollectorRoute = pathname.startsWith("/collector");
  // Check for auth routes - handle both (auth) and /login, /signup formats
  const isAuthRoute = pathname.startsWith("/(auth)") || pathname === "/login" || pathname === "/signup" || pathname === "/forgot-password";

  // Redirect root to collector dashboard
  if (pathname === "/") {
    // Check if authenticated, if yes go to dashboard, else login
    if (isAuthenticated(request)) {
      return NextResponse.redirect(new URL("/collector/dashboard", request.url));
    } else {
      return NextResponse.redirect(new URL("/(auth)/login", request.url));
    }
  }

  // Redirect legacy routes
  if (pathname === "/login") {
    return NextResponse.redirect(new URL("/(auth)/login", request.url));
  }

  if (pathname === "/signup") {
    return NextResponse.redirect(new URL("/(auth)/signup", request.url));
  }

  if (pathname.startsWith("/dashboard") && !pathname.startsWith("/dashboard/(guest)")) {
    return NextResponse.redirect(new URL(pathname.replace("/dashboard", "/app"), request.url));
  }

  // Protect collector routes - require authentication
  if (isCollectorRoute) {
    if (!isAuthenticated(request)) {
      // Redirect to login with return URL
      const loginUrl = new URL("/(auth)/login", request.url);
      loginUrl.searchParams.set("redirect", pathname);
      return NextResponse.redirect(loginUrl);
    }

    // Add user info to headers for server components (optional)
    const user = getAuthenticatedUser(request);
    if (user) {
      const response = NextResponse.next();
      response.headers.set("x-user-id", user.id);
      response.headers.set("x-tenant-id", user.tenantId);
      return response;
    }
  }

  // Redirect authenticated users away from auth pages
  if (isAuthRoute) {
    try {
      if (isAuthenticated(request)) {
        // Check for redirect parameter
        const redirectTo = request.nextUrl.searchParams.get("redirect");
        if (redirectTo && redirectTo.startsWith("/collector")) {
          return NextResponse.redirect(new URL(redirectTo, request.url));
        }
        return NextResponse.redirect(new URL("/collector/dashboard", request.url));
      }
    } catch (error) {
      // If auth check fails, allow access to auth pages
      console.error('Auth check error:', error);
    }
  }

    return NextResponse.next();
  } catch (error: any) {
    console.error('Middleware error:', error);
    // If middleware fails, allow request to continue
    return NextResponse.next();
  }
  */
}

export const config = {
  matcher: [
    "/",
    "/login",
    "/signup",
    "/dashboard/:path*",
    "/collector/:path*",
    "/(auth)/:path*",
  ],
};
