global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option log-health-checks
    option forwardfor
    option http-server-close
    timeout connect 5000ms
    timeout client 50000ms
    timeout server 50000ms
    timeout http-request 15s
    timeout http-keep-alive 1s

# Stats interface
frontend stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE

# Health check endpoint
frontend health
    bind *:9999
    http-request return status 200 content-type text/plain string "OK"

# Main frontend - Routes to Kong API Gateway
frontend collector-frontend
    bind *:80
    # SSL bind commented out - add SSL certificate to enable
    # bind *:443 ssl crt /etc/ssl/certs/cert.pem
    
    # Redirect HTTP to HTTPS (disabled until SSL cert is added)
    # redirect scheme https code 301 if !{ ssl_fc }
    
    # CORS headers
    http-response set-header Access-Control-Allow-Origin "*"
    http-response set-header Access-Control-Allow-Methods "GET,POST,PUT,DELETE,OPTIONS"
    http-response set-header Access-Control-Allow-Headers "Content-Type,Authorization,x-tenant-id"
    
    # Route to Kong API Gateway
    default_backend kong-backend

# Kong API Gateway backend
backend kong-backend
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    server kong1 kong:8000 check inter 10s fall 3 rise 2

# Optional: Direct service backends (if not using Kong)
# Uncomment these when microservices are running
# backend registry-service-backend
#     balance roundrobin
#     option httpchk GET /health
#     http-check expect status 200
#     server registry1 registry-service:3001 check inter 10s fall 3 rise 2
#     server registry2 registry-service:3001 check inter 10s fall 3 rise 2 backup

# backend invoices-service-backend
#     balance roundrobin
#     option httpchk GET /health
#     http-check expect status 200
#     server invoices1 invoices-service:3002 check inter 10s fall 3 rise 2
#     server invoices2 invoices-service:3002 check inter 10s fall 3 rise 2 backup

# backend orders-service-backend
#     balance roundrobin
#     option httpchk GET /health
#     http-check expect status 200
#     server orders1 orders-service:3003 check inter 10s fall 3 rise 2

# backend delivery-service-backend
#     balance roundrobin
#     option httpchk GET /health
#     http-check expect status 200
#     server delivery1 delivery-service:3004 check inter 10s fall 3 rise 2

# backend offers-service-backend
#     balance roundrobin
#     option httpchk GET /health
#     http-check expect status 200
#     server offers1 offers-service:3005 check inter 10s fall 3 rise 2

